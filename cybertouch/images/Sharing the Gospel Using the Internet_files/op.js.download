allowedOrigins=["*.churchofjesuschrist.org","*.deserettrust.com","id.churchofjesuschrist.org"];let Origin=null,idpBase="https://id.churchofjesuschrist.org";function sendMessage(e,t){window.top.postMessage(JSON.stringify(e),t)}function allowedDomain(e){var t=getHostName(e),n="*."+getDomain(e),s=allowedOrigins.includes(e),o=allowedOrigins.includes(t),r=allowedOrigins.includes(n);return s||o||r}function handleVisibilityChange(){document.hidden||Origin&&isUserLoggedIn().then((e=>{sendMessage({command:"isUserLoggedIn",reply:e},Origin)}))}function processMessage(e){return new Promise(((t,n)=>{let s={};try{s=JSON.parse(e)}catch(e){console.debug("Message could not be parsed.")}let o={command:s.command,reply:null};switch(s.command){case"ping":o.reply="pong: "+s.payload,t(o);break;case"isUserLoggedIn":isUserLoggedIn().then((e=>{o.reply=e,t(o)}));break;case"getCurrentUser":isUserLoggedIn().then((e=>{o.reply=e,t(o)}));case"userLogout":console.debug("userLogout command received."),userLogout();break;default:o.reply="not a defined command",n(o)}}))}function getSessionUser(){return new Promise(((e,t)=>{fetch(idpBase+"/api/v1/sessions/me",{method:"GET",credentials:"include",mode:"cors"}).then((n=>{"200"==n.status?n.json().then((t=>{let n=constructCurrentUser(t);e(n)})):t()}))}))}function getUserProfile(e){return new Promise((t=>{fetch(idpBase+"/api/v1/users/me",{method:"GET",credentials:"include",mode:"cors"}).then((n=>{200==n.status?n.json().then((n=>{getUserToken(e.name,e.userId,n.profile.churchAccountID).then((n=>{e.token=n,t(e)}))})):(e.profile=null,e.token=null,t(e))}))}))}function getUserToken(e,t,n){let s={};return s.name=e,s.id=t,s.altId=n,new Promise(((e,t)=>{fetch("/token",{method:"POST",body:JSON.stringify(s),headers:{"Content-Type":"application/json"}}).then((t=>{200==t.status?(console.debug("we should have a token"),t.text().then((t=>{e(t)}))):e(void 0)})).catch((function(){e(void 0)}))}))}function constructCurrentUser(e){return{userId:e.userId,name:e._links.user.name,status:e.status,mfaActive:e.mfaActive,expiresAt:e.expiresAt}}function constructAnonymousUser(){var e=new Date;return e.setMinutes(e.getMinutes()+30),currentUser={userId:0,name:"anonymous",status:"ANON",expiresAt:e.toISOString()},currentUser}function isUserLoggedIn(e=!1){return new Promise(((t,n)=>{let s=localStorage.currentUser,o=getCookie("opinit"),r="true"===getCookie("checkuser");if(!s||e||!o||r)getSessionUser().then((e=>{getUserProfile(e).then((e=>{document.cookie="checkuser=;path=/;domain=churchofjesuschrist.org;expires=Thu, 01 Jan 1970 00:00:01 GMT;",localStorage.currentUser=JSON.stringify(e),document.cookie="opinit=true;",t(e)}))}),(e=>{if(document.cookie="opinit=true;",s){let e=JSON.parse(s);e.status="EXPIRED";var n=new Date;n.setMinutes(n.getMinutes()+30),e.expiresAt=n.toISOString(),localStorage.currentUser=JSON.stringify(e),t(e)}else anonymousUser=constructAnonymousUser(),localStorage.currentUser=JSON.stringify(anonymousUser),t(anonymousUser)}));else{var i=new Date,a=Date.UTC(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds());let e=JSON.parse(s);var u=Date.parse(e.expiresAt);if(document.cookie="opinit=true;",minsApart(a,u)<5)isUserLoggedIn(!0).then((e=>t(e)));else if(u<a){console.debug("USER EXPIRED"),e.status="EXPIRED",(i=new Date).setMinutes(i.getMinutes()+30),e.expiresAt=i.toISOString(),localStorage.currentUser=JSON.stringify(e),t(e)}else t(e)}}))}function minsApart(e,t){var n=Math.abs(e-t);return Math.floor(n/1e3/60)}function userLogout(){console.debug("called user logout"),localStorage.removeItem("currentUser")}function isExternal(e){var t=e.match(/^([^:\/?#]+:)?(?:\/\/([^\/?#]*))?([^?#]+)?(\?[^#]*)?(#.*)?/);return null!=t&&"string"==typeof t[1]&&t[1].length>0&&t[1].toLowerCase()!==location.protocol||null!=t&&"string"==typeof t[2]&&t[2].length>0&&t[2].replace(new RegExp(":("+{"http:":80,"https:":443}[location.protocol]+")?$"),"")!==location.host}function getHostName(e){var t=e.match(/:\/\/(www[0-9]?\.)?(.[^/:]+)/i);return null!=t&&t.length>2&&"string"==typeof t[2]&&t[2].length>0?t[2]:null}function getDomain(e){var t=getHostName(e),n=t;if(null!=t){var s=t.split(".").reverse();null!=s&&s.length>1&&(n=s[1]+"."+s[0],-1!=t.toLowerCase().indexOf(".co.uk")&&s.length>2&&(n=s[2]+"."+n))}return n}function getCookie(e){const t=e+"=";let n;return decodeURIComponent(document.cookie).split("; ").forEach((e=>{0===e.indexOf(t)&&(n=e.substring(t.length))})),n}window.addEventListener("message",(function(e){allowedDomain(e.origin)?processMessage(e.data).then((t=>{Origin=e.origin,sendMessage(t,e.origin)})).catch((()=>{})):console.debug("NO access from "+e.origin)})),document.addEventListener("visibilitychange",handleVisibilityChange,!1);
